<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Innioasis Firmware Downloader</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* Light mode colors */
            --bg-primary: #ffffff;
            --bg-secondary: #f5f5f7;
            --bg-tertiary: #fafafa;
            --text-primary: #1d1d1f;
            --text-secondary: #86868b;
            --text-tertiary: #6e6e73;
            --accent-primary: #007aff;
            --accent-secondary: #5856d6;
            --accent-success: #34c759;
            --accent-warning: #ff9500;
            --accent-error: #ff3b30;
            --border-primary: #d2d2d7;
            --border-secondary: #e5e5e7;
            --shadow-primary: rgba(0, 0, 0, 0.1);
            --shadow-secondary: rgba(0, 0, 0, 0.05);
            --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --gradient-secondary: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        [data-theme="dark"] {
            /* Dark mode colors */
            --bg-primary: #000000;
            --bg-secondary: #1c1c1e;
            --bg-tertiary: #2c2c2e;
            --text-primary: #ffffff;
            --text-secondary: #98989d;
            --text-tertiary: #8e8e93;
            --accent-primary: #0a84ff;
            --accent-secondary: #5e5ce6;
            --accent-success: #30d158;
            --accent-warning: #ff9f0a;
            --accent-error: #ff453a;
            --border-primary: #38383a;
            --border-secondary: #48484a;
            --shadow-primary: rgba(0, 0, 0, 0.3);
            --shadow-secondary: rgba(0, 0, 0, 0.2);
            --gradient-primary: linear-gradient(135deg, #1c1c1e 0%, #2c2c2e 100%);
            --gradient-secondary: linear-gradient(135deg, #2c2c2e 0%, #3a3a3c 100%);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', 'Helvetica Neue', Helvetica, Arial, sans-serif;
            background: var(--bg-primary);
            min-height: 100vh;
            color: var(--text-primary);
            line-height: 1.6;
            transition: all 0.3s ease;
        }

        /* Dark mode styles */
        body[data-theme="dark"] {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: #f8f9fa;
        }

        body[data-theme="dark"] .main-content {
            background: #2c2c2e;
            color: #ffffff;
        }

        body[data-theme="dark"] .filters {
            background: #3a3a3c;
            color: #ffffff;
            border-color: #48484a;
        }

        body[data-theme="dark"] .filter-group label {
            color: #ffffff;
        }

        body[data-theme="dark"] .filter-group select {
            background: #2c2c2e;
            color: #ffffff;
            border-color: #48484a;
        }

        body[data-theme="dark"] .firmware-list {
            color: #ffffff;
        }

        body[data-theme="dark"] .firmware-item {
            background: #3a3a3c;
            color: #ffffff;
            border-color: #48484a;
        }

        body[data-theme="dark"] .firmware-name {
            color: #ffffff;
        }

        body[data-theme="dark"] .detail-label {
            color: #8e8e93;
        }

        body[data-theme="dark"] .detail-value {
            color: #c7c7cc;
        }

        body[data-theme="dark"] .platform-dialog {
            background: #2c2c2e;
            color: #ffffff;
            border-color: #48484a;
        }

        body[data-theme="dark"] .platform-dialog h3 {
            color: #ffffff;
        }

        body[data-theme="dark"] .platform-dialog p {
            color: #c7c7cc;
        }

        body[data-theme="dark"] .step-content {
            background: #3a3a3c;
            color: #ffffff;
            border-color: #48484a;
        }

        body[data-theme="dark"] .step-content h4 {
            color: #8e8e93;
        }

        body[data-theme="dark"] .step-content p {
            color: #c7c7cc;
        }

        body[data-theme="dark"] .step-content li {
            color: #c7c7cc;
        }

        body[data-theme="dark"] .driver-item {
            background: #3a3a3c;
            color: #ffffff;
            border-color: #48484a;
        }

        body[data-theme="dark"] .driver-item p {
            color: #c7c7cc;
        }

        body[data-theme="dark"] .command-display {
            background: #3a3a3c;
            border-color: #48484a;
        }

        body[data-theme="dark"] .command-display code {
            color: #c7c7cc;
        }

        body[data-theme="dark"] .alternative-link {
            color: #8e8e93;
        }

        body[data-theme="dark"] .alternative-link:hover {
            color: #c7c7cc;
        }

        body[data-theme="dark"] .footer {
            color: white;
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.2);
        }

        body[data-theme="dark"] .footer a {
            color: white;
        }

        body[data-theme="dark"] .platform-dialog p {
            color: #ffffff;
        }


        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 15px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
            position: relative;
        }

        .theme-toggle {
            position: absolute;
            top: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.15);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 12px 18px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1.1rem;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            backdrop-filter: blur(15px);
            font-weight: 600;
            min-width: 120px;
            justify-content: center;
        }

        .theme-toggle:hover {
            background: rgba(255, 255, 255, 0.25);
            border-color: rgba(255, 255, 255, 0.5);
            transform: translateY(-2px);
        }

        .theme-toggle .icon {
            font-size: 1.3rem;
        }

        .header-icon {
            width: 80px;
            height: 80px;
            border-radius: 20px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
            transition: transform 0.3s ease;
        }

        .header-icon:hover {
            transform: scale(1.05);
        }

        .header-text {
            flex: 1;
            min-width: 300px;
        }

        .header h1 {
            font-size: 2.2rem;
            margin-bottom: 8px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1rem;
            opacity: 0.9;
        }

        .main-content {
            background: var(--bg-secondary);
            border-radius: 24px;
            padding: 30px;
            box-shadow: 0 8px 32px var(--shadow-primary);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border-secondary);
        }

        .filters {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
            padding: 25px;
            background: var(--bg-primary);
            border-radius: 20px;
            border: 1px solid var(--border-secondary);
            box-shadow: 0 4px 16px var(--shadow-secondary);
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        .filter-group label {
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-primary);
            font-size: 0.9rem;
            letter-spacing: -0.01em;
        }

        .filter-group select {
            padding: 12px 16px;
            border: 1px solid var(--border-primary);
            border-radius: 12px;
            font-size: 14px;
            background: var(--bg-primary);
            color: var(--text-primary);
            transition: all 0.3s ease;
            font-family: inherit;
        }

        .filter-group select:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
        }

        .refresh-btn {
            background: var(--accent-primary);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            align-self: end;
            font-size: 0.9rem;
            font-family: inherit;
            box-shadow: 0 4px 16px rgba(0, 122, 255, 0.3);
        }

        .refresh-btn:hover {
            transform: translateY(-2px);
        }

        .refresh-btn:active {
            transform: translateY(0);
        }

        .firmware-list {
            background: var(--bg-primary);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 30px;
            border: 1px solid var(--border-secondary);
            box-shadow: 0 4px 16px var(--shadow-secondary);
        }

        .firmware-list h3 {
            margin-bottom: 20px;
            color: var(--text-primary);
            font-size: 1.3rem;
            font-weight: 700;
            letter-spacing: -0.02em;
        }

        .firmware-item {
            background: white;
            border-radius: 12px;
            padding: 18px;
            margin-bottom: 12px;
            border: 1px solid #e9ecef;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .firmware-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            border-color: #667eea;
        }

        .firmware-item.selected {
            border-color: #667eea;
            background: linear-gradient(135deg, #f8f9ff 0%, #f0f2ff 100%);
        }

        .firmware-name {
            font-size: 1.1rem;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 8px;
            position: relative;
            overflow: hidden;
        }

        /* Scrolling text animation for long version names */
        .firmware-name.scroll-text,
        .detail-value.scroll-text {
            white-space: nowrap;
            animation: scrollText 8s linear infinite;
            cursor: pointer;
            position: relative;
            display: inline-block;
            min-width: 0;
        }

        .firmware-name.scroll-text:hover,
        .detail-value.scroll-text:hover {
            animation-play-state: paused;
            white-space: normal;
            overflow: visible;
        }

        /* Touch devices - pause animation on touch */
        .firmware-name.scroll-text:active,
        .detail-value.scroll-text:active {
            animation-play-state: paused;
        }

        @keyframes scrollText {
            0% {
                transform: translateX(0);
            }
            25% {
                transform: translateX(0);
            }
            75% {
                transform: translateX(calc(-100% + 200px));
            }
            100% {
                transform: translateX(calc(-100% + 200px));
            }
        }

        /* Pause animation when user is interacting */
        .firmware-item:hover .scroll-text {
            animation-play-state: paused;
        }

        /* Download statistics styling */
        .download-stats {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 8px;
            padding: 8px 12px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 8px;
            font-size: 0.85rem;
            border: 1px solid #dee2e6;
            transition: all 0.3s ease;
        }

        .firmware-item:hover .download-stats {
            background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%);
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .download-stats .stat-item {
            display: flex;
            align-items: center;
            gap: 4px;
            color: #6c757d;
            transition: color 0.3s ease;
        }

        .download-stats .stat-icon {
            font-size: 0.9rem;
            transition: transform 0.3s ease;
        }

        .firmware-item:hover .download-stats .stat-icon {
            transform: scale(1.1);
        }

        .download-stats .stat-value {
            font-weight: 600;
            color: #495057;
            transition: color 0.3s ease;
        }

        .firmware-item:hover .download-stats .stat-value {
            color: #007bff;
        }

        .download-stats .stat-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            opacity: 0.8;
        }

        /* Dark mode styles for download stats */
        body[data-theme="dark"] .download-stats {
            background: linear-gradient(135deg, #3a3a3c 0%, #2c2c2e 100%);
            border-color: #48484a;
        }

        body[data-theme="dark"] .firmware-item:hover .download-stats {
            background: linear-gradient(135deg, #2c2c2e 0%, #1c1c1e 100%);
        }

        body[data-theme="dark"] .download-stats .stat-item {
            color: #8e8e93;
        }

        body[data-theme="dark"] .download-stats .stat-value {
            color: #c7c7cc;
        }

        body[data-theme="dark"] .firmware-item:hover .download-stats .stat-value {
            color: #0a84ff;
        }

        .firmware-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
            margin-bottom: 15px;
        }

        .detail-item {
            display: flex;
            flex-direction: column;
        }

        .detail-label {
            font-size: 0.75rem;
            color: #6c757d;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }

        .detail-value {
            font-weight: 600;
            color: #495057;
            font-size: 0.9rem;
        }

        .download-btn {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
        }

        .download-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.3);
        }

        .download-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }

        .download-section {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .download-rom-btn {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            font-size: 1rem;
        }

        .download-rom-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.3);
        }

        .automatic-install-btn {
            background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            font-size: 1rem;
        }

        .automatic-install-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(23, 162, 184, 0.3);
        }

        .status {
            text-align: center;
            padding: 8px 12px;
            background: transparent;
            border-radius: 6px;
            margin-bottom: 12px;
            border: none;
            font-size: 0.9rem;
            opacity: 0.7;
            color: var(--text-secondary);
        }

        .status.error {
            background: rgba(255, 59, 48, 0.1);
            color: var(--accent-error);
            opacity: 1;
        }

        .status.loading {
            background: rgba(255, 149, 0, 0.1);
            color: var(--accent-warning);
            opacity: 1;
        }
        
        .token-status {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            padding: 15px;
            margin: 18px 0;
            text-align: center;
        }
        
        .token-info {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .token-label {
            font-weight: 600;
            color: #495057;
        }
        
        .token-count {
            background: #667eea;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 0.9em;
        }
        
        .token-status-text {
            color: #6c757d;
            font-size: 0.9em;
        }
        
        .token-refresh-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.8em;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        
        .token-refresh-btn:hover {
            background: #218838;
        }
        
        .token-details-btn {
            background: #17a2b8;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.8em;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        
        .token-details-btn:hover {
            background: #138496;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            width: 0%;
            transition: width 0.3s ease;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .footer {
            text-align: center;
            margin-top: 30px;
            color: var(--text-primary);
            opacity: 0.8;
            padding: 20px;
            background: var(--bg-secondary);
            border-radius: 15px;
            backdrop-filter: blur(10px);
            border: 1px solid var(--border-primary);
        }

        .footer a {
            color: var(--accent-primary);
            text-decoration: none;
            transition: opacity 0.3s ease;
        }

        .footer a:hover {
            text-decoration: underline;
            opacity: 1;
        }



        /* Platform-specific dialog styles */
        .platform-dialog {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            z-index: 2000;
            max-width: 500px;
            width: 90%;
            text-align: center;
            display: none;
        }

        .platform-dialog.show {
            display: block;
        }

        .platform-dialog h3 {
            color: #e74c3c;
            margin-bottom: 15px;
            font-size: 1.3rem;
        }

        .platform-dialog p {
            margin-bottom: 20px;
            line-height: 1.6;
            color: var(--text-primary);
        }

        .platform-dialog .btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            margin: 0 10px;
        }

        .platform-dialog .btn:hover {
            background: #c0392b;
            transform: translateY(-2px);
        }

        .platform-dialog .btn-secondary {
            background: #6c757d;
        }

        .platform-dialog .btn-secondary:hover {
            background: #5a6268;
        }

        /* Platform Guides Grid */
        .platform-guides-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .platform-guide-btn {
            padding: 15px 10px;
            font-size: 0.9rem;
            min-height: 60px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }

        .dialog-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1999;
            display: none;
        }

        .dialog-overlay.show {
            display: block;
        }

        /* Command box styles */
        .command-box {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-primary);
            border-radius: 12px;
            padding: 16px;
            margin: 15px 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;
        }

        .command-box code {
            background: var(--bg-primary);
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid var(--border-secondary);
            font-size: 0.9rem;
            color: var(--text-primary);
            flex: 1;
            word-break: break-all;
        }

        .copy-btn {
            background: var(--accent-primary);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .copy-btn:hover {
            background: var(--accent-secondary);
            transform: translateY(-1px);
        }

        .copy-btn:active {
            transform: translateY(0);
        }

        @media (max-width: 768px) {
            
            .container {
                padding: 10px;
            }
            
            .header {
                flex-direction: column;
                gap: 15px;
            }
            
            .header-icon {
                width: 60px;
                height: 60px;
            }
            
            .header h1 {
                font-size: 1.8rem;
            }
            
            .main-content {
                padding: 20px;
            }
            
            .filters {
                grid-template-columns: 1fr;
                gap: 12px;
            }
            
            .firmware-details {
                grid-template-columns: 1fr;
            }
            
            /* Mobile-specific scrolling text improvements */
            .firmware-name.scroll-text {
                animation-duration: 6s; /* Faster on mobile */
                touch-action: pan-x; /* Allow horizontal scrolling on touch */
            }
            
            .detail-value.scroll-text {
                animation-duration: 5s; /* Faster for detail values */
                touch-action: pan-x;
            }
            
            /* Download stats mobile layout */
            .download-stats {
                flex-direction: column;
                gap: 6px;
                align-items: flex-start;
            }
            
            .download-stats .stat-item {
                width: 100%;
                justify-content: space-between;
            }
        }
        
        @media (max-width: 480px) {
            .header h1 {
                font-size: 1.5rem;
            }
            
            .header p {
                font-size: 0.9rem;
            }
            
            .container {
                padding: 8px;
            }
            
            .main-content {
                padding: 15px;
            }
        }

        /* macOS Installation Steps */
        .mac-step {
            text-align: left;
            margin: 20px 0;
        }

        .step-content {
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }

        .step-content h4 {
            color: #667eea;
            margin: 0 0 15px 0;
            font-size: 1.2rem;
        }

        .step-content p {
            margin: 12px 0;
            line-height: 1.6;
        }

        .step-content ol {
            margin: 15px 0;
            padding-left: 20px;
        }

        .step-content li {
            margin: 8px 0;
            line-height: 1.5;
        }

        .step-actions {
            margin-top: 25px;
            text-align: center;
        }

        .step-actions .btn {
            margin: 0 10px;
        }

        .alternative-install {
            text-align: center;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #dee2e6;
        }

        .alternative-link {
            color: #6c757d;
            text-decoration: none;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .alternative-link:hover {
            color: #495057;
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <img src="mtkclient/gui/images/icon.png" alt="Innioasis Icon" class="header-icon">
            <div class="header-text">
                <h1>Innioasis Firmware Downloader</h1>
                <p>Download firmware releases directly from GitHub</p>
            </div>
            <button class="theme-toggle" onclick="toggleTheme()">
                <span class="icon">🌓</span>
                <span>Auto</span>
            </button>
        </div>

        <div class="main-content">

            <div class="filters">
                <div class="filter-group">
                    <label for="deviceType">Device Type</label>
                    <select id="deviceType">
                        <option value="">All Types</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label for="deviceModel">Device Model</label>
                    <select id="deviceModel">
                        <option value="">All Models</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label for="software">Software</label>
                    <select id="software">
                        <option value="">All Software</option>
                    </select>
                </div>
                
                <button class="refresh-btn" onclick="refreshData()">
                    🔄 Refresh
                </button>
            </div>
            
            <!-- Token Status Display -->
            <div id="tokenStatus" class="token-status" style="display: none;">
                <div class="token-info">
                    <span class="token-label">GitHub API Tokens:</span>
                    <span id="tokenCount" class="token-count">0</span>
                    <span class="token-status-text" id="tokenStatusText">Loading...</span>
                    <button id="refreshTokensBtn" class="token-refresh-btn" onclick="refreshTokens()" style="display: none;">
                        🔄 Refresh Tokens
                    </button>
                    <button id="showTokenDetailsBtn" class="token-details-btn" onclick="showTokenDetails()" style="display: none;">
                        📊 Token Details
                    </button>
                </div>
            </div>

            <div class="status" id="status">
                Ready to download firmware
            </div>

            <div class="firmware-list">
                <h3>Available Firmware</h3>
                <div id="firmwareContainer">
                    <p style="text-align: center; color: #6c757d;">Select filters and click refresh to load firmware</p>
                </div>
            </div>
        </div>

        <div class="footer">
            <p>Created by <a href="https://ko-fi.com/teamslide" target="_blank">Team Slide</a> | 
               <a href="https://innioasis.app" target="_blank">Innioasis App</a> | 
               <a href="https://discord.gg/Timmkoo" target="_blank">Discord</a></p>
            <p style="margin-top: 10px; font-size: 0.9rem; opacity: 0.7;">🍪 Cookies not used by this site</p>
        </div>
    </div>


    <!-- Platform-specific dialogs -->
    <div class="dialog-overlay" id="dialogOverlay"></div>
    
    <!-- Windows Dialog -->
    <div class="platform-dialog" id="windowsDialog">
        <h3>🪟 Windows Installation</h3>
        
        <!-- Step 1: Getting Started -->
        <div class="windows-step" id="windowsStep1">
            <div class="step-content">
                <h4>Getting Started</h4>
                <p>Before we can install the updater, you'll need two drivers so your computer can talk to your Y1 properly:</p>
                
                <div class="driver-downloads">
                    <div class="driver-item">
                        <p><strong>MediaTek Driver:</strong> This lets your computer recognize your Y1 device</p>
                        <button class="btn btn-primary" onclick="downloadDriver('mtk')">📥 Download MediaTek Driver</button>
                    </div>
                    
                    <div class="driver-item">
                        <p><strong>USB Development Kit:</strong> This helps with USB communication</p>
                        <button class="btn btn-primary" onclick="downloadDriver('usbdk')">📥 Download USB Development Kit</button>
                    </div>
                </div>
                
                <div class="step-actions">
                    <button class="btn btn-primary" onclick="nextWindowsStep()">Next →</button>
                    <button class="btn btn-secondary" onclick="closeDialog()">Close</button>
                </div>
            </div>
        </div>
        
        <!-- Step 2: Install & Run -->
        <div class="windows-step" id="windowsStep2" style="display: none;">
            <div class="step-content">
                <h4>Install & Run</h4>
                <p>Now let's get the actual updater app:</p>
                <button class="btn btn-primary" onclick="downloadWindows()">📥 Download Windows Installer</button>
                
                <div class="step-actions">
                    <button class="btn btn-secondary" onclick="prevWindowsStep()">← Back</button>
                    <button class="btn btn-primary" onclick="nextWindowsStep()">Next →</button>
                </div>
            </div>
        </div>
        
        <!-- Step 3: Final Steps -->
        <div class="windows-step" id="windowsStep3" style="display: none;">
            <div class="step-content">
                <h4>Almost Done!</h4>
                <p>Here's what to do next:</p>
                <ol>
                    <li>Install the MediaTek driver you downloaded</li>
                    <li>Install the USB Development Kit</li>
                    <li>Install the Innioasis Updater</li>
                    <li><strong>Restart your computer</strong></li>
                    <li>Launch Innioasis Updater from the Start Menu</li>
                </ol>
                
                <p><strong>Important:</strong> Don't skip the restart - it makes sure everything works properly!</p>
                
                <div class="step-actions">
                    <button class="btn btn-secondary" onclick="prevWindowsStep()">← Back</button>
                    <button class="btn btn-primary" onclick="closeDialog()">Finish</button>
                </div>
            </div>
        </div>
    </div>

    <!-- macOS Dialog -->
    <div class="platform-dialog" id="macDialog">
        <h3>🍎 macOS Installation</h3>
        
        <!-- Step 1: Prerequisites -->
        <div class="mac-step" id="macStep1">
            <div class="step-content">
                <h4>Prerequisites</h4>
                <p>Before installing Innioasis Updater, you'll need <a href="https://github.com/Homebrew/brew/releases/latest" target="_blank" class="homebrew-link">Homebrew</a> package manager on your Mac.</p>
                <p>Homebrew helps manage dependencies and ensures everything works smoothly.</p>
                
                <div class="step-actions">
                    <button class="btn btn-primary" onclick="nextMacStep()">Next →</button>
                    <button class="btn btn-secondary" onclick="closeDialog()">Close</button>
                </div>
            </div>
        </div>
        
        <!-- Step 2: Download -->
        <div class="mac-step" id="macStep2" style="display: none;">
            <div class="step-content">
                <h4>Download Innioasis Updater</h4>
                <p>Click the button below to download the macOS app package (.dmg file):</p>
                <button class="btn btn-primary" onclick="downloadMacDMG()">📥 Download for Mac</button>
                
                <div class="step-actions">
                    <button class="btn btn-secondary" onclick="prevMacStep()">← Back</button>
                    <button class="btn btn-primary" onclick="nextMacStep()">Next →</button>
                </div>
            </div>
        </div>
        
        <!-- Step 3: Installation -->
        <div class="mac-step" id="macStep3" style="display: none;">
            <div class="step-content">
                <h4>Install & Run</h4>
                <p>After downloading:</p>
                <ol>
                    <li>Double-click the .dmg file</li>
                    <li>Drag the Innioasis Updater app to your Applications folder</li>
                    <li>Launch the app from Applications</li>
                </ol>
                
                <p><strong>Note:</strong> You may need to <a href="#" id="appleGuideLink" target="_blank" class="apple-guide-link">allow apps from unknown developers</a> in System Preferences.</p>
                
                <div class="step-actions">
                    <button class="btn btn-secondary" onclick="prevMacStep()">← Back</button>
                    <button class="btn btn-primary" onclick="closeDialog()">Finish</button>
                </div>
            </div>
        </div>
        
        <!-- Alternative Install Method Link -->
        <div class="alternative-install">
            <a href="#" onclick="showMacTerminalInstall(); return false;" class="alternative-link">
                🔧 Alternative Install Method (Terminal)
            </a>
        </div>
    </div>

    <!-- Linux Dialog -->
    <div class="platform-dialog" id="linuxDialog">
        <h3>🐧 Linux Installation</h3>
        <p>Ubuntu is recommended for the best experience, but other distributions should work as well. Follow the instructions in the new tab to set up the required dependencies.</p>
        <button class="btn" onclick="openLinuxInstructions()">Open Instructions</button>
        <button class="btn btn-secondary" onclick="closeDialog()">Close</button>
    </div>

    <!-- ChromeOS/FydeOS Dialog -->
    <div class="platform-dialog" id="chromeosDialog">
        <h3>🖥️ ChromeOS/FydeOS</h3>
        <p>You MAY be able to run Innioasis Updater in Linux mode, but we have not tested this configuration. Follow the Linux instructions in the new tab and try running it in your Linux environment.</p>
        <p><em>Note: This is experimental and may not work as expected.</em></p>
        <button class="btn" onclick="openLinuxInstructions()">View Linux Instructions</button>
        <button class="btn btn-secondary" onclick="closeDialog()">Close</button>
    </div>

    <!-- Windows ARM64 Dialog -->
    <div class="platform-dialog" id="windowsArmDialog">
        <h3>🪟 Windows ARM64</h3>
        <p>For Windows ARM64 users, more advanced users may be able to run the Linux version using Python, Libusb, android-platform-tools, USBIPD-win and WSLg. Ubuntu is recommended.</p>
        <button class="btn" onclick="openLinuxInstructions()">View Linux Instructions</button>
        <button class="btn btn-secondary" onclick="closeDialog()">Close</button>
    </div>

    <!-- Platform Guides Dialog -->
    <div class="platform-dialog" id="platformGuidesDialog">
        <h3>🌍 Platform Setup Guides</h3>
        <p>Choose your platform to view detailed setup instructions:</p>
        <div class="platform-guides-grid">
            <button class="btn platform-guide-btn" onclick="navigateToPlatform('windowsDialog')">🪟 Windows</button>
            <button class="btn platform-guide-btn" onclick="navigateToPlatform('macDialog')">🍎 macOS</button>
            <button class="btn platform-guide-btn" onclick="navigateToPlatform('linuxDialog')">🐧 Linux</button>
        </div>
        <button class="btn btn-secondary" onclick="closeDialog()">Close</button>
    </div>

    <script>
        // Global variables
        let packages = [];
        let currentFilters = {
            deviceType: '',
            deviceModel: '',
            software: ''
        };
        
        // GitHub API tokens management
        let githubTokens = [];
        let currentTokenIndex = 0;
        let tokenCallCounts = {};
        const TOKEN_RATE_LIMIT = 5000; // GitHub's rate limit per hour per token

        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            setupEventListeners();
            detectUserOS();
            checkSavedTheme();
        });

        // Detect user's operating system and update CTA banner
        function detectUserOS() {
            const userAgent = navigator.userAgent;
            let os = 'Windows';
            let isArm64 = false;
            
            if (userAgent.includes('Mac')) {
                os = 'macOS';
            } else if (userAgent.includes('Linux')) {
                os = 'Linux';
            } else if (userAgent.includes('CrOS') || userAgent.includes('FydeOS')) {
                os = 'ChromeOS/FydeOS';
            }
            
            // Check for Windows ARM64
            if (userAgent.includes('Windows') && (userAgent.includes('ARM64') || userAgent.includes('ARM'))) {
                isArm64 = true;
            }
            
            // Store platform info globally
            window.userPlatform = { os, isArm64 };
        }



        // Platform-specific download functions
        function downloadForPlatform() {
            const platform = window.userPlatform;
            
            if (platform.isArm64) {
                showDialog('windowsArmDialog');
            } else if (platform.os === 'Windows') {
                showDialog('windowsDialog');
            } else if (platform.os === 'macOS') {
                showDialog('macDialog');
            } else if (platform.os === 'Linux') {
                showDialog('linuxDialog');
            } else if (platform.os === 'ChromeOS/FydeOS') {
                showDialog('chromeosDialog');
            }
        }

        function downloadWindows() {
            // Download Windows installer
            const url = 'https://github.com/team-slide/Innioasis-Updater/releases/download/1.0.0/Innioasis.Updater.-.Windows.exe';
            
            // For Safari, open in new tab, for other browsers use download attribute
            if (navigator.userAgent.includes('Safari') && !navigator.userAgent.includes('Chrome')) {
                window.open(url, '_blank');
                setTimeout(() => {
                    alert('🎉 Opening download page in new tab! Click the download button on the GitHub page.');
                }, 1000);
            } else {
                const link = document.createElement('a');
                link.href = url;
                link.download = 'Innioasis.Updater.-.Windows.exe';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                setTimeout(() => {
                    alert('🎉 Download started! The Windows installer is downloading to your Downloads folder.');
                }, 1000);
            }
        }

        function downloadDriver(driverType) {
            let url, filename;
            
            if (driverType === 'mtk') {
                url = 'https://github.com/team-slide/Innioasis-Updater/releases/download/1.0.0/driver_mtk.exe';
                filename = 'driver_mtk.exe';
            } else if (driverType === 'usbdk') {
                url = 'https://github.com/team-slide/Innioasis-Updater/releases/download/1.0.0/driver_usbdk.msi';
                filename = 'driver_usbdk.msi';
            }
            
            if (url) {
                // For Safari, open in new tab, for other browsers use download attribute
                if (navigator.userAgent.includes('Safari') && !navigator.userAgent.includes('Chrome')) {
                    window.open(url, '_blank');
                    setTimeout(() => {
                        alert(`🎉 Opening ${driverType === 'mtk' ? 'MediaTek driver' : 'USB Development Kit'} download page in new tab! Click the download button on the GitHub page.`);
                    }, 1000);
                } else {
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = filename;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    setTimeout(() => {
                        alert(`🎉 Download started! The ${driverType === 'mtk' ? 'MediaTek driver' : 'USB Development Kit'} is downloading to your Downloads folder.`);
                    }, 1000);
                }
            }
        }

        function openMacInstructions() {
            window.open('https://github.com/team-slide/Innioasis-Updater#manual-setup', '_blank');
        }

        function copyMacCommand() {
            const command = '/bin/bash -c "$(curl -fsSL https://mac.innioasis.app)"';
            
            if (navigator.clipboard && window.isSecureContext) {
                // Use modern clipboard API
                navigator.clipboard.writeText(command).then(() => {
                    showCopySuccess();
                }).catch(() => {
                    fallbackCopyTextToClipboard(command);
                });
            } else {
                // Fallback for older browsers
                fallbackCopyTextToClipboard(command);
            }
        }

        function fallbackCopyTextToClipboard(text) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.left = '-999999px';
            textArea.style.top = '-999999px';
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
                document.execCommand('copy');
                showCopySuccess();
            } catch (err) {
                console.error('Fallback: Oops, unable to copy', err);
            }
            
            document.body.removeChild(textArea);
        }

        function showCopySuccess() {
            const copyBtn = document.querySelector('.copy-btn');
            const originalText = copyBtn.textContent;
            copyBtn.textContent = '✅ Copied!';
            copyBtn.style.background = 'var(--accent-success)';
            
            setTimeout(() => {
                copyBtn.textContent = originalText;
                copyBtn.style.background = 'var(--accent-primary)';
            }, 2000);
        }

        function openLinuxInstructions() {
            window.open('https://github.com/team-slide/Innioasis-Updater#linux---ubuntu-recommended', '_blank');
        }

        function showDialog(dialogId) {
            document.getElementById('dialogOverlay').classList.add('show');
            document.getElementById(dialogId).classList.add('show');
            
            // Update Apple guide link if showing macOS dialog
            if (dialogId === 'macDialog') {
                updateAppleGuideLink();
            }
            
            // Initialize Windows steps if showing Windows dialog
            if (dialogId === 'windowsDialog') {
                // Hide all steps except first
                for (let i = 2; i <= 3; i++) {
                    document.getElementById(`windowsStep${i}`).style.display = 'none';
                }
                document.getElementById('windowsStep1').style.display = 'block';
            }
        }

        function closeDialog() {
            document.getElementById('dialogOverlay').classList.remove('show');
            document.querySelectorAll('.platform-dialog').forEach(dialog => {
                dialog.classList.remove('show');
            });
        }

        // Close dialog when clicking overlay
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('dialogOverlay').addEventListener('click', closeDialog);
            checkSavedTheme();
        });

        function setupEventListeners() {
            document.getElementById('deviceType').addEventListener('change', function() {
                populateSoftwareCombo();
                filterFirmware();
            });
            document.getElementById('deviceModel').addEventListener('change', function() {
                populateSoftwareCombo();
                filterFirmware();
            });
            document.getElementById('software').addEventListener('change', filterFirmware);
        }

        async function loadData() {
            try {
                setStatus('Loading configuration and manifest data...', 'loading');
                
                // Load GitHub API tokens first
                await loadGitHubTokens();
                
                // Load manifest data
                const manifestResponse = await fetch('https://raw.githubusercontent.com/team-slide/slidia/refs/heads/main/slidia_manifest.xml');
                if (!manifestResponse.ok) {
                    throw new Error('Failed to load manifest');
                }
                
                const manifestText = await manifestResponse.text();
                packages = parseManifest(manifestText);
                
                if (packages.length === 0) {
                    throw new Error('No packages found in manifest');
                }
                
                console.log(`Loaded ${packages.length} software packages`);
                
                // Populate filters
                populateDeviceTypeCombo();
                populateDeviceModelCombo();
                populateSoftwareCombo();
                
                // Apply default filters and load firmware
                filterFirmware();
                
                // Load initial firmware list
                await loadFirmwareList();
                
                setStatus('Ready to download firmware');
                
            } catch (error) {
                console.error('Error loading data:', error);
                setStatus(`Error loading data: ${error.message}`, 'error');
            }
        }

        async function loadGitHubTokens() {
            try {
                setStatus('Loading GitHub API tokens...', 'loading');
                
                // Load tokens from the config file
                const configResponse = await fetch('https://raw.githubusercontent.com/team-slide/y1-helper/main/config.ini');
                if (!configResponse.ok) {
                    throw new Error('Failed to load config file');
                }
                
                const configText = await configResponse.text();
                const tokens = parseConfigTokens(configText);
                
                if (tokens.length === 0) {
                    console.warn('No GitHub API tokens found in config file');
                    setStatus('Warning: No GitHub API tokens available - using unauthenticated requests');
                    updateTokenStatus(0, 'No tokens available - using unauthenticated requests');
                } else {
                    console.log(`Loaded ${tokens.length} GitHub API tokens`);
                    setStatus(`Loaded ${tokens.length} GitHub API tokens`);
                    updateTokenStatus(tokens.length, `${tokens.length} tokens loaded successfully`);
                }
                
                githubTokens = tokens;
                
                // Initialize token call counts
                tokens.forEach(token => {
                    tokenCallCounts[token] = 0;
                });
                
            } catch (error) {
                console.warn('Failed to load GitHub tokens:', error);
                setStatus('Warning: Using unauthenticated GitHub API requests');
                updateTokenStatus(0, 'Failed to load tokens - using unauthenticated requests');
                githubTokens = [];
            }
        }
        
        function parseConfigTokens(configText) {
            const tokens = [];
            const lines = configText.split('\n');
            
            for (const line of lines) {
                const trimmedLine = line.trim();
                
                // Parse key_1, key_2, etc. entries
                if (trimmedLine.startsWith('key_') && trimmedLine.includes('=')) {
                    const [key, value] = trimmedLine.split('=').map(s => s.trim());
                    if (value && value !== '') {
                        // Add github_pat_ prefix if not present
                        const token = value.startsWith('github_pat_') ? value : `github_pat_${value}`;
                        tokens.push(token);
                    }
                }
                
                // Parse token = entry
                if (trimmedLine.startsWith('token = ')) {
                    const value = trimmedLine.substring(8).trim();
                    if (value && value !== '') {
                        // Add github_pat_ prefix if not present
                        const token = value.startsWith('github_pat_') ? value : `github_pat_${value}`;
                        tokens.push(token);
                    }
                }
            }
            
            return tokens;
        }
        
        function getNextAvailableToken() {
            if (githubTokens.length === 0) {
                return null; // No tokens available
            }
            
            // Find a token that hasn't exceeded rate limit
            for (let i = 0; i < githubTokens.length; i++) {
                const tokenIndex = (currentTokenIndex + i) % githubTokens.length;
                const token = githubTokens[tokenIndex];
                
                if (tokenCallCounts[token] < TOKEN_RATE_LIMIT) {
                    currentTokenIndex = (tokenIndex + 1) % githubTokens.length;
                    return token;
                }
            }
            
            // All tokens have exceeded rate limit, reset counts and use first available
            console.warn('All tokens have exceeded rate limit, resetting counts');
            Object.keys(tokenCallCounts).forEach(token => {
                tokenCallCounts[token] = 0;
            });
            currentTokenIndex = 0;
            return githubTokens[0];
        }
        
        function updateTokenStatus(count, statusText) {
            const tokenStatusElement = document.getElementById('tokenStatus');
            const tokenCountElement = document.getElementById('tokenCount');
            const tokenStatusTextElement = document.getElementById('tokenStatusText');
            const refreshTokensBtn = document.getElementById('refreshTokensBtn');
            const showTokenDetailsBtn = document.getElementById('showTokenDetailsBtn');
            
            if (tokenStatusElement && tokenCountElement && tokenStatusTextElement) {
                tokenCountElement.textContent = count;
                
                // Add usage information if tokens are available
                if (count > 0) {
                    const totalCalls = Object.values(tokenCallCounts).reduce((sum, count) => sum + count, 0);
                    const statusWithUsage = `${statusText} (${totalCalls} API calls made)`;
                    tokenStatusTextElement.textContent = statusWithUsage;
                } else {
                    tokenStatusTextElement.textContent = statusText;
                }
                
                tokenStatusElement.style.display = count > 0 ? 'block' : 'none';
                
                // Show buttons if tokens are available
                if (refreshTokensBtn) {
                    refreshTokensBtn.style.display = count > 0 ? 'inline-block' : 'none';
                }
                if (showTokenDetailsBtn) {
                    showTokenDetailsBtn.style.display = count > 0 ? 'inline-block' : 'none';
                }
            }
        }
        
        async function refreshTokens() {
            try {
                setStatus('Refreshing GitHub API tokens...', 'loading');
                await loadGitHubTokens();
                setStatus('GitHub API tokens refreshed successfully');
            } catch (error) {
                console.error('Error refreshing tokens:', error);
                setStatus(`Error refreshing tokens: ${error.message}`, 'error');
            }
        }
        
        function showTokenDetails() {
            if (githubTokens.length === 0) {
                alert('No tokens available');
                return;
            }
            
            let details = `GitHub API Token Details:\n\n`;
            details += `Total Tokens: ${githubTokens.length}\n`;
            details += `Current Token Index: ${currentTokenIndex}\n\n`;
            
            githubTokens.forEach((token, index) => {
                const callCount = tokenCallCounts[token] || 0;
                const remainingCalls = TOKEN_RATE_LIMIT - callCount;
                const status = callCount >= TOKEN_RATE_LIMIT ? 'RATE LIMITED' : 'ACTIVE';
                const shortToken = token.substring(0, 8) + '...';
                
                details += `Token ${index + 1}: ${shortToken}\n`;
                details += `  Calls Made: ${callCount}/${TOKEN_RATE_LIMIT}\n`;
                details += `  Remaining: ${remainingCalls}\n`;
                details += `  Status: ${status}\n\n`;
            });
            
            alert(details);
        }
        
        function parseManifest(xmlText) {
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(xmlText, 'text/xml');
            const packageElements = xmlDoc.getElementsByTagName('package');
            
            const packages = [];
            for (let pkg of packageElements) {
                packages.push({
                    name: pkg.getAttribute('name') || 'Unknown',
                    device_type: pkg.getAttribute('device_type') || '',
                    repo: pkg.getAttribute('repo') || '',
                    device: pkg.getAttribute('device') || '',
                    url: pkg.getAttribute('url') || '',
                    type: pkg.getAttribute('type') || '',
                    handler: pkg.getAttribute('handler') || ''
                });
            }
            
            return packages;
        }

        function populateDeviceTypeCombo() {
            const combo = document.getElementById('deviceType');
            const deviceTypes = [...new Set(packages.map(p => p.device_type).filter(t => t))];
            
            combo.innerHTML = '<option value="">All Types</option>';
            deviceTypes.sort().forEach(type => {
                const option = document.createElement('option');
                option.value = type;
                option.textContent = `Type ${type}`;
                // Set Type A as default
                if (type && type.toLowerCase().includes('a')) {
                    option.selected = true;
                }
                combo.appendChild(option);
            });
        }

        function populateDeviceModelCombo() {
            const combo = document.getElementById('deviceModel');
            const deviceModels = [...new Set(packages.map(p => p.device).filter(m => m))];
            
            combo.innerHTML = '<option value="">All Models</option>';
            deviceModels.sort().forEach(model => {
                const option = document.createElement('option');
                option.value = model;
                option.textContent = model;
                // Set Y1 as default
                if (model && model.toLowerCase().includes('y1')) {
                    option.selected = true;
                }
                combo.appendChild(option);
            });
        }

        function populateSoftwareCombo() {
            const combo = document.getElementById('software');
            const selectedType = document.getElementById('deviceType').value;
            const selectedModel = document.getElementById('deviceModel').value;
            
            // Get filtered software names based on current device type and model selections
            const filteredPackages = packages.filter(package => {
                const typeMatch = !selectedType || package.device_type === selectedType;
                const modelMatch = !selectedModel || package.device === selectedModel;
                return typeMatch && modelMatch;
            });
            
            const softwareNames = [...new Set(filteredPackages.map(p => p.name).filter(n => n))];
            
            combo.innerHTML = '<option value="">All Software</option>';
            softwareNames.sort().forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                // Set Original as default
                if (name && name.toLowerCase().includes('original')) {
                    option.selected = true;
                }
                combo.appendChild(option);
            });
        }

        function filterFirmware() {
            currentFilters.deviceType = document.getElementById('deviceType').value;
            currentFilters.deviceModel = document.getElementById('deviceModel').value;
            currentFilters.software = document.getElementById('software').value;
            
            loadFirmwareList();
        }

        async function loadFirmwareList() {
            try {
                setStatus('Loading firmware releases...', 'loading');
                
                const container = document.getElementById('firmwareContainer');
                container.innerHTML = '<div class="loading-spinner"></div> Loading...';
                
                // Get filtered packages
                const filteredPackages = packages.filter(pkg => {
                    const typeMatch = !currentFilters.deviceType || pkg.device_type === currentFilters.deviceType;
                    const modelMatch = !currentFilters.deviceModel || pkg.device === currentFilters.deviceModel;
                    const softwareMatch = !currentFilters.software || pkg.name === currentFilters.software;
                    
                    return typeMatch && modelMatch && softwareMatch;
                });
                
                if (filteredPackages.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: #6c757d;">No firmware found matching the selected filters</p>';
                    setStatus('No firmware found');
                    return;
                }
                
                // Load releases for each package
                const allReleases = [];
                for (const pkg of filteredPackages) {
                    try {
                        const releases = await getReleases(pkg.repo);
                        releases.forEach(release => {
                            release.software_name = pkg.name;
                            release.device_type = pkg.device_type;
                            release.device_model = pkg.device;
                            allReleases.push(release);
                        });
                    } catch (error) {
                        console.warn(`Failed to load releases for ${pkg.repo}:`, error);
                    }
                }
                
                // Sort releases by date (newest first)
                allReleases.sort((a, b) => new Date(b.published_at) - new Date(a.published_at));
                
                // Display releases
                displayFirmwareList(allReleases);
                setStatus(`Loaded ${allReleases.length} firmware releases`);
                
            } catch (error) {
                console.error('Error loading firmware list:', error);
                setStatus(`Error loading firmware: ${error.message}`, 'error');
                document.getElementById('firmwareContainer').innerHTML = 
                    '<p style="text-align: center; color: #c0392b;">Failed to load firmware list</p>';
            }
        }

        async function getReleases(repo) {
            try {
                const token = getNextAvailableToken();
                const headers = {};
                
                if (token) {
                    headers['Authorization'] = `Bearer ${token}`;
                    headers['Accept'] = 'application/vnd.github.v3+json';
                    
                    // Increment call count for this token
                    tokenCallCounts[token]++;
                    console.log(`Using token for ${repo} (call count: ${tokenCallCounts[token]})`);
                } else {
                    console.log(`No token available for ${repo}, using unauthenticated request`);
                }
                
                const response = await fetch(`https://api.github.com/repos/${repo}/releases`, {
                    headers: headers
                });
                
                if (!response.ok) {
                    if (response.status === 403) {
                        // Rate limit exceeded or token invalid
                        console.warn(`Rate limit or token issue for ${repo}, status: ${response.status}`);
                        if (token) {
                            // Mark this token as having issues
                            tokenCallCounts[token] = TOKEN_RATE_LIMIT;
                            console.warn(`Token ${token.substring(0, 8)}... marked as rate limited`);
                            
                            // Update token status to show the issue
                            updateTokenStatus(githubTokens.length, `${githubTokens.length} tokens loaded (some rate limited)`);
                        }
                    }
                    throw new Error(`GitHub API error: ${response.status}`);
                }
                
                const releases = await response.json();
                return releases
                    .filter(release => {
                        // Only include releases that have a rom.zip file
                        const hasRomZip = release.assets && release.assets.some(asset => 
                            asset.name && asset.name.toLowerCase() === 'rom.zip'
                        );
                        return hasRomZip;
                    })
                    .map(release => {
                        // Find the rom.zip asset and get its download count
                        const romZipAsset = release.assets.find(asset => 
                            asset.name && asset.name.toLowerCase() === 'rom.zip'
                        );
                        
                        return {
                            tag_name: release.tag_name,
                            name: release.name || release.tag_name,
                            published_at: release.published_at,
                            html_url: release.html_url,
                            assets: release.assets || [],
                            download_count: romZipAsset ? romZipAsset.download_count : 0,
                            total_downloads: release.assets.reduce((sum, asset) => sum + (asset.download_count || 0), 0)
                        };
                    });
            } catch (error) {
                console.warn(`Failed to fetch releases for ${repo}:`, error);
                return [];
            }
        }

        function displayFirmwareList(releases) {
            const container = document.getElementById('firmwareContainer');
            
            if (releases.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #6c757d;">No releases found</p>';
                return;
            }
            
            container.innerHTML = releases.map(release => {
                // Check if version name is long enough to need scrolling
                const needsScrolling = release.tag_name.length > 20 || release.name.length > 20;
                const versionClass = needsScrolling ? 'firmware-name scroll-text' : 'firmware-name';
                
                // Format download counts
                const formatDownloadCount = (count) => {
                    if (count >= 1000000) {
                        return (count / 1000000).toFixed(1) + 'M';
                    } else if (count >= 1000) {
                        return (count / 1000).toFixed(1) + 'K';
                    }
                    return count.toString();
                };
                
                return `
                    <div class="firmware-item" onclick="selectFirmware(this, '${release.software_name}')">
                        <div class="firmware-name">${release.software_name}</div>
                        <div class="firmware-details">
                            <div class="detail-item">
                                <div class="detail-label">Version</div>
                                <div class="detail-value ${needsScrolling ? 'scroll-text' : ''}" title="${release.tag_name}" onclick="event.stopPropagation(); toggleScrollingAnimation(this.closest('.firmware-item'))">${release.tag_name}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Name</div>
                                <div class="detail-value ${needsScrolling ? 'scroll-text' : ''}" title="${release.name}" onclick="event.stopPropagation(); toggleScrollingAnimation(this.closest('.firmware-item'))">${release.name}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Published</div>
                                <div class="detail-value">${formatDate(release.published_at)}</div>
                            </div>
                            ${!currentFilters.deviceType ? `<div class="detail-item">
                                <div class="detail-label">Type</div>
                                <div class="detail-value">${release.device_type || 'N/A'}</div>
                            </div>` : ''}
                            ${!currentFilters.deviceModel ? `<div class="detail-item">
                                <div class="detail-label">Model</div>
                                <div class="detail-value">${release.device_model || 'N/A'}</div>
                            </div>` : ''}
                        </div>
                        <div class="download-stats">
                            <div class="stat-item">
                                <span class="stat-icon">📦</span>
                                <span class="stat-value">${formatDownloadCount(release.download_count || 0)}</span>
                                <span class="stat-label">ROM Downloads</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-icon">📊</span>
                                <span class="stat-value">${formatDownloadCount(release.total_downloads || 0)}</span>
                                <span class="stat-label">Total Downloads</span>
                            </div>
                        </div>
                        <div class="download-section">
                            <button class="download-rom-btn" onclick="downloadROM('${release.html_url}', event)">
                                📥 Download ROM
                            </button>
                            <button class="automatic-install-btn" onclick="goToInnioasisApp(event)">
                                ⚡ Automatic Install at Innioasis.app
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Add touch handling for scrolling text
            setTimeout(() => {
                document.querySelectorAll('.firmware-item').forEach(item => {
                    handleScrollingTextTouch(item);
                });
            }, 100);
        }

        function selectFirmware(element, softwareName) {
            // Remove previous selection
            document.querySelectorAll('.firmware-item').forEach(item => {
                item.classList.remove('selected');
            });
            
            // Add selection to clicked item
            element.classList.add('selected');
        }

        // Handle touch interactions for scrolling text
        function handleScrollingTextTouch(element) {
            const scrollTexts = element.querySelectorAll('.scroll-text');
            scrollTexts.forEach(textElement => {
                textElement.addEventListener('touchstart', function() {
                    this.style.animationPlayState = 'paused';
                });
                
                textElement.addEventListener('touchend', function() {
                    setTimeout(() => {
                        this.style.animationPlayState = 'running';
                    }, 1000);
                });
            });
        }

        // Toggle scrolling animation
        function toggleScrollingAnimation(element) {
            const scrollTexts = element.querySelectorAll('.scroll-text');
            scrollTexts.forEach(textElement => {
                if (textElement.style.animationPlayState === 'paused') {
                    textElement.style.animationPlayState = 'running';
                } else {
                    textElement.style.animationPlayState = 'paused';
                }
            });
        }

        function downloadROM(releasesUrl, event) {
            event.stopPropagation();
            
            // Open the GitHub releases page in a new tab for ROM download
            window.open(releasesUrl, '_blank');
        }

        function goToInnioasisApp(event) {
            event.stopPropagation();
            
            // Direct users to the install guide for automatic installation
            window.open('https://innioasis.app/installguide.html', '_blank');
        }

        function formatDate(dateString) {
            try {
                const date = new Date(dateString);
                return date.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            } catch (error) {
                return dateString;
            }
        }

        function setStatus(message, type = '') {
            const statusElement = document.getElementById('status');
            statusElement.textContent = message;
            statusElement.className = `status ${type}`;
        }

        function refreshData() {
            loadData();
        }

        // Handle errors gracefully
        window.addEventListener('error', function(e) {
            console.error('Global error:', e.error);
            setStatus('An unexpected error occurred', 'error');
        });

        // Handle unhandled promise rejections
        window.addEventListener('unhandledrejection', function(e) {
            console.error('Unhandled promise rejection:', e.reason);
            setStatus('Network or API error occurred', 'error');
        });

        // macOS Step Navigation Functions
        function downloadMacDMG() {
            // Download macOS DMG installer
            const url = 'https://github.com/team-slide/Innioasis-Updater/releases/download/1.0.0/Innioasis.Updater.for.Mac.dmg';
            
            // For Safari, open in new tab, for other browsers use download attribute
            if (navigator.userAgent.includes('Safari') && !navigator.userAgent.includes('Chrome')) {
                window.open(url, '_blank');
                setTimeout(() => {
                    alert('🎉 Opening download page in new tab! Click the download button on the GitHub page.');
                }, 1000);
            } else {
                const link = document.createElement('a');
                link.href = url;
                link.download = 'Innioasis.Updater.for.Mac.dmg';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                setTimeout(() => {
                    alert('🎉 Download started! The DMG file is downloading to your Downloads folder.');
                }, 1000);
            }
        }

        function nextMacStep() {
            const currentStep = getCurrentMacStep();
            if (currentStep < 3) {
                hideMacStep(currentStep);
                showMacStep(currentStep + 1);
                updateAppleGuideLink();
            }
        }

        function prevMacStep() {
            const currentStep = getCurrentMacStep();
            if (currentStep > 1) {
                hideMacStep(currentStep);
                showMacStep(currentStep - 1);
            }
        }

        function getCurrentMacStep() {
            for (let i = 1; i <= 3; i++) {
                if (document.getElementById(`macStep${i}`).style.display !== 'none') {
                    return i;
                }
            }
            return 1;
        }

        function showMacStep(stepNumber) {
            document.getElementById(`macStep${stepNumber}`).style.display = 'block';
        }

        function hideMacStep(stepNumber) {
            document.getElementById(`macStep${stepNumber}`).style.display = 'none';
        }

        function updateAppleGuideLink() {
            // Get macOS version and update the Apple guide link
            const userAgent = navigator.userAgent;
            let macVersion = '14.0'; // Default to macOS 14
            
            if (userAgent.includes('Mac OS X 10_15')) {
                macVersion = '10.15'; // macOS Catalina
            } else if (userAgent.includes('Mac OS X 11_')) {
                macVersion = '11.0'; // macOS Big Sur
            } else if (userAgent.includes('Mac OS X 12_')) {
                macVersion = '12.0'; // macOS Monterey
            } else if (userAgent.includes('Mac OS X 13_')) {
                macVersion = '13.0'; // macOS Ventura
            } else if (userAgent.includes('Mac OS X 14_')) {
                macVersion = '14.0'; // macOS Sonoma
            } else if (userAgent.includes('Mac OS X 15_')) {
                macVersion = '15.0'; // macOS Sequoia
            }
            
            const appleGuideLink = document.getElementById('appleGuideLink');
            if (appleGuideLink) {
                appleGuideLink.href = `https://support.apple.com/en-gb/guide/mac-help/mh40616/${macVersion}/mac/${macVersion}`;
            }
        }

        function showMacTerminalInstall() {
            // Show terminal installation method
            const terminalDialog = document.createElement('div');
            terminalDialog.className = 'platform-dialog show';
            terminalDialog.innerHTML = `
                <h3>🍎 App not working?</h3>
                <p>Try running this command in Terminal:</p>
                <div class="command-display">
                    <code>curl -fsSL https://mac.innioasis.app | bash</code>
                </div>
                <button class="btn" onclick="copyMacCommand()">📋 Copy Command</button>
                <button class="btn btn-secondary" onclick="closeTerminalDialog()">Close</button>
            `;
            
            document.body.appendChild(terminalDialog);
            document.getElementById('dialogOverlay').classList.add('show');
        }

        function closeTerminalDialog() {
            const terminalDialog = document.querySelector('.platform-dialog.show:not(#macDialog)');
            if (terminalDialog) {
                terminalDialog.remove();
            }
            document.getElementById('dialogOverlay').classList.remove('show');
        }

        // Navigate between platform dialogs
        function navigateToPlatform(dialogId) {
            // Close the platform guides dialog
            closeDialog();
            // Show the selected platform dialog
            setTimeout(() => {
                showDialog(dialogId);
            }, 100);
        }

        // Windows Step Navigation Functions
        function nextWindowsStep() {
            const currentStep = getCurrentWindowsStep();
            if (currentStep < 3) {
                hideWindowsStep(currentStep);
                showWindowsStep(currentStep + 1);
            }
        }

        function prevWindowsStep() {
            const currentStep = getCurrentWindowsStep();
            if (currentStep > 1) {
                hideWindowsStep(currentStep);
                showWindowsStep(currentStep - 1);
            }
        }

        function getCurrentWindowsStep() {
            for (let i = 1; i <= 3; i++) {
                if (document.getElementById(`windowsStep${i}`).style.display !== 'none') {
                    return i;
                }
            }
            return 1;
        }

        function showWindowsStep(stepNumber) {
            document.getElementById(`windowsStep${stepNumber}`).style.display = 'block';
        }

        function hideWindowsStep(stepNumber) {
            document.getElementById(`windowsStep${stepNumber}`).style.display = 'none';
        }

        // Theme toggle functionality - cycles through Auto → Light → Dark
        function toggleTheme() {
            const body = document.body;
            const themeToggle = document.querySelector('.theme-toggle');
            const icon = themeToggle.querySelector('.icon');
            const text = themeToggle.querySelector('span:not(.icon)');
            const currentTheme = localStorage.getItem('theme') || 'auto';
            
            let newTheme;
            if (currentTheme === 'auto') {
                newTheme = 'light';
            } else if (currentTheme === 'light') {
                newTheme = 'dark';
            } else {
                newTheme = 'auto';
            }
            
            localStorage.setItem('theme', newTheme);
            applyTheme(newTheme);
        }

        // Apply the specified theme
        function applyTheme(theme) {
            const body = document.body;
            const themeToggle = document.querySelector('.theme-toggle');
            const icon = themeToggle.querySelector('.icon');
            const text = themeToggle.querySelector('span:not(.icon)');
            
            if (theme === 'auto') {
                // Check system preference
                if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                    body.setAttribute('data-theme', 'dark');
                    icon.textContent = '🌓';
                    text.textContent = 'Auto';
                } else {
                    body.removeAttribute('data-theme');
                    icon.textContent = '🌓';
                    text.textContent = 'Auto';
                }
            } else if (theme === 'dark') {
                body.setAttribute('data-theme', 'dark');
                icon.textContent = '☀️';
                text.textContent = 'Light';
            } else {
                body.removeAttribute('data-theme');
                icon.textContent = '🌙';
                text.textContent = 'Dark';
            }
        }

        // Check saved theme preference and system theme
        function checkSavedTheme() {
            const savedTheme = localStorage.getItem('theme') || 'auto';
            applyTheme(savedTheme);
            
            // Listen for system theme changes when in auto mode
            if (savedTheme === 'auto') {
                window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
                    if (localStorage.getItem('theme') === 'auto') {
                        if (e.matches) {
                            document.body.setAttribute('data-theme', 'dark');
                        } else {
                            document.body.removeAttribute('data-theme');
                        }
                    }
                });
            }
        }
    </script>

    <!-- Ko-Fi Floating Chat Widget -->
    <script src='https://storage.ko-fi.com/cdn/scripts/overlay-widget.js'></script>
    <script>
      kofiWidgetOverlay.draw('teamslide', {
        'type': 'floating-chat',
        'floating-chat.donateButton.text': 'Support me',
        'floating-chat.donateButton.background-color': '#00b9fe',
        'floating-chat.donateButton.text-color': '#fff'
      });
    </script>
</body>
</html>
